# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'ë¦´ë¦¬ì¦ˆ/íƒœê·¸ëª…(ë¯¸ì…ë ¥ ì‹œ csproj <Version> ë˜ëŠ” v<run_number>)'
        required: false
      prerelease:
        description: 'í”„ë¦¬ë¦´ë¦¬ì¦ˆë¡œ í‘œì‹œí• ê¹Œìš”?'
        type: boolean
        default: false
      draft:
        description: 'Draft(ì„ì‹œì €ì¥)ë¡œ ë§Œë“¤ê¹Œìš”?'
        type: boolean
        default: false
      notes:
        description: 'ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸(ì„ íƒ)'
        required: false

permissions:
  contents: write   # Release ìƒì„±/ì—…ë¡œë“œì— í•„ìš”

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      PROJECT_PATH: MapleLib/MapleLib.csproj
      DLL_NAME: MapleLib.dll

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build (Release)
        run: dotnet build "${{ env.PROJECT_PATH }}" -c Release -v minimal --no-restore

      - name: Find MapleLib.dll
        id: find_dll
        shell: pwsh
        run: |
          $projDir = Split-Path "${{ env.PROJECT_PATH }}" -Parent
          $dll = Get-ChildItem -Path "$projDir\bin\Release" -Recurse -Filter "${{ env.DLL_NAME }}" |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if (-not $dll) { throw "âŒ ${env:DLL_NAME} not found under $projDir\bin\Release" }
          "DLL_PATH=$($dll.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "âœ… Found: $($dll.FullName)"

      - name: Resolve tag/version
        id: ver
        shell: pwsh
        run: |
          $inputTag = "${{ github.event.inputs.tag }}".Trim()
          if ($inputTag) {
            $tag = $inputTag
          } else {
            # Try <Version> from csproj
            $csproj = "${{ env.PROJECT_PATH }}"
            [xml]$xml = Get-Content $csproj
            $ver = $xml.Project.PropertyGroup.Version
            if ($ver) { $tag = "v$ver" } else { $tag = "v${{ github.run_number }}" }
          }
          "TAG=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "ğŸ”– Tag resolved: $tag"

      - name: Create/Update GitHub Release
        id: gh_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.TAG }}
          name: ${{ steps.ver.outputs.TAG }}
          body: ${{ github.event.inputs.notes }}
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: ${{ github.event.inputs.notes == '' }}
          files: ${{ steps.find_dll.outputs.DLL_PATH }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
